import { useEffect, useRef, useState } from "react";
import { Link } from "react-router-dom";
import TwoBtnModal from "../common/TwoBtnModal.jsx";
import axios from "axios";
import GoldMedal from "../../assets/Medal-Gold.svg?react";
import SilverMedal from "../../assets/Medal-Silver.svg?react";
import BronzeMedal from "../../assets/Medal-Bronze.svg?react";

export default function RestReviews() {
  // ‚úÖ ÌôïÏù∏Ïö© Î∞©Î¨∏ ÌûàÏä§ÌÜ†Î¶¨
  const [visit, setVisit] = useState([])


  useEffect(() => {
    const fetchProfile = async () => {
      try {
        const response = await axios.get("/restaurants/myreview", {
          matchingHistoryId: 1,
        });
        setVisit(response.data);
      } catch (error) {
        console.error("ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§", error);
      }
    };
    fetchProfile();
  }, []); // üî• ÏµúÏ¥à Ìïú Î≤àÎßå Ïã§Ìñâ

  // ‚úÖ Ïã†Í≥†ÌïòÍ∏∞ Ï∞®Îã®ÌïòÍ∏∞ ÌåùÏò§Î≤Ñ Ï∞Ω ÌëúÏãú
  // ÌÅ¥Î¶≠Îêú ÏöîÏÜåÏùò IDÎ•º Í¥ÄÎ¶¨
  const [activePopOver, setActivePopOver] = useState(null);
  const popOverRef = useRef(null); // ÌòÑÏû¨ Ïó¥Î¶∞ popOverÏùò ref

  // ÌåùÏò§Î≤Ñ ÌÜ†Í∏Ä Ìï®Ïàò
  const popOver = (id) => {
    setActivePopOver(activePopOver === id ? null : id);
  };

  // Ïô∏Î∂Ä ÌÅ¥Î¶≠ Í∞êÏßÄÌïòÏó¨ ÌåùÏò§Î≤Ñ Îã´Í∏∞
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (popOverRef.current && !popOverRef.current.contains(event.target)) {
        setActivePopOver(null);
      }
    };
    if (activePopOver !== null) {
      document.addEventListener("mousedown", handleClickOutside);
    }

    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [activePopOver]);

  // ‚úÖ Ï∞®Îã®, Ïã†Í≥† Î™®Îã¨
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [modalType, setModalType] = useState(null); // Ï∞®Îã® or Ïã†Í≥† Íµ¨Î∂Ñ
  const [userId, setUserId] = useState(null); // Ï∞®Îã® or Ïã†Í≥† Íµ¨Î∂Ñ

  // ‚úÖ Î™®Îã¨ Ïó¥Í≥† Îã´Í∏∞ Ìï®Ïàò
  const toggleModal = (type, id) => {
    setModalType(type); // ÌÅ¥Î¶≠Ìïú Î≤ÑÌäºÏùò ÌÉÄÏûÖ Ï†ÄÏû•
    setIsModalOpen(true);
    setActivePopOver(null);
    setUserId(id);
  };

  // ÏàòÏ†ï ÏùÑ Îã§Ïãú Ï¢Ä ÌñàÏäµÎãàÎã§.
  const [showOneBtnModal, setShowOneBtnModal] = useState(false);

  const changeState = async (type, id) => {
    let visitIdx = 0;
    let idIdx = 0;
    let copyArr = [...visit]; // ‚úÖ Î∞∞Ïó¥ÏùÑ Î≥µÏÇ¨ÌïòÏó¨ Î≥ÄÍ≤Ω

    visit.forEach((visitItem, idx) => {
      visitItem.visitors.forEach((item, itemIndex) => {
        if (item.id === id) {
          visitIdx = idx;
          idIdx = itemIndex;
        }
      });
    });

    const user = copyArr[visitIdx].visitors[idIdx];

    try {
      if (type === "block") {
        const newBlockState = !user.block; // Ï∞®Îã® ÏÉÅÌÉú Î≥ÄÍ≤Ω
        await axios.post(`/ban?bannedId=${id}`); // Ï∞®Îã® ÏöîÏ≤≠
        user.block = newBlockState;
      } else if (type === "unBlock") {
        const newBlockState = !user.block; // Ï∞®Îã® Ìï¥Ï†ú ÏÉÅÌÉú Î≥ÄÍ≤Ω
        await axios.delete(`/ban?bannedId=${id}`); // Ï∞®Îã® Ìï¥Ï†ú ÏöîÏ≤≠
        user.block = newBlockState;
      } else if (type === "report") {
        const newReportState = !user.report; // Ïã†Í≥† ÏÉÅÌÉú Î≥ÄÍ≤Ω
        await axios.post(`/report?reportedId=${id}`); // Ïã†Í≥† ÏöîÏ≤≠
        user.report = newReportState;
      } else if (type === "unReport") {
        const newReportState = !user.report; // Ïã†Í≥† Ìï¥Ï†ú ÏÉÅÌÉú Î≥ÄÍ≤Ω
        await axios.delete(`/report?reportedId=${id}`); // Ïã†Í≥† Ìï¥Ï†ú ÏöîÏ≤≠
        user.report = newReportState;
      }
      setVisit(copyArr); // ‚úÖ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      setShowOneBtnModal(true);
    } catch (error) {
      console.error("ÏÑúÎ≤Ñ ÏöîÏ≤≠ Ïã§Ìå®:", error);
    }
  };


  // ‚úÖ Î™®Îã¨ Îã´Í∏∞ Ìï®Ïàò
  const closeModal = () => {
    setIsModalOpen(false);
    setModalType(null);
    setShowOneBtnModal(false);
  };

  // ‚úÖ Ï∞®Îã® or Ïã†Í≥† ÌëúÏãú
  const benOrBlock = (visitor) => {
    if (visitor.report === true && visitor.block === true) {
      return (
        <>
          <span className="ml-2 px-1.5 py-0.5 bg-[#FFACAC] text-[#E62222] rounded-md whitespace-nowrap">Ïã†Í≥† Ïú†Ï†Ä</span>
          <span className="ml-2 px-1.5 py-0.5 bg-[#FFACAC] text-[#E62222] rounded-md whitespace-nowrap">Ï∞®Îã® Ïú†Ï†Ä</span>
        </>
      );
    } else if (visitor.block === true) {
      return <span className="ml-2 px-1.5 py-0.5 bg-[#FFACAC] text-[#E62222] rounded-md whitespace-nowrap">Ï∞®Îã® Ïú†Ï†Ä</span>;
    } else if (visitor.report === true) {
      return <span className="ml-2 px-1.5 py-0.5 bg-[#FFACAC] text-[#E62222] rounded-md whitespace-nowrap">Ïã†Í≥† Ïú†Ï†Ä</span>;
    }
  };

  // Îß§Ïπ≠ ÌöüÏàòÎ≥Ñ Î©îÎã¨ ÌëúÏãú
  const viewMedal = (matchingCount) => {
    if (matchingCount >= 5) {
      return (
        <GoldMedal width="16px" height="16px"/>
      )
    } else if (matchingCount >= 3) {
      return (
        <SilverMedal width="16px" height="16px"/>
      )
    } else if (matchingCount >= 1) {
      return (
        <BronzeMedal width="16px" height="16px"/>
      )
    } else {
      return (
        <></>
      )
    }
  }

  return (
    <div
      className="flex flex-col gap-10 flex-auto min-w-fit border border-[#ff6445] bg-white drop-shadow-lg rounded-2xl py-10 px-14">
      <p className="font-bold text-[28px] text-left">ÎÇòÏùò Î∞©Î¨∏Í∏∞Î°ù</p>
      {/* ÏãùÎãπ Î≥Ñ Îß§Ïπ≠ ÌûàÏä§ÌÜ†Î¶¨ Î∞ïÏä§*/}
      <ul className="flex flex-col flex-1 gap-4 overflow-y-scroll scrollbar-hide">
        {/* Î∞©Î¨∏Ìïú ÏãùÎãπÏù¥ ÏûàÏúºÎ©¥ Î∞©Î¨∏ Ìïú ÏãùÎãπ ÌûàÏä§ÌÜ†Î¶¨ ÌëúÏãú*/}
        {visit.length > 0 ? (
          // Í∞ôÏù¥ Î∞©Î¨∏Ìïú ÏÇ¨ÎûåÎì§ Î¶¨Ïä§Ìä∏ ÌëúÏãú
          visit.map((visitItem) => (
            <li
              key={visitItem.id}
              className="flex flex-col gap-4 rounded-2xl"
            >
              <div className="flex justify-between items-center">
                <div className="flex flex-shrink-0 items-end">
                  <span>{visitItem.place_name}</span>
                  <span className="text-sm text-gray-400 pl-2">
                    {visitItem.category_name}
                  </span>
                </div>
                <span
                  className="flex flex-shrink-0 text-[15px] text-[#909090] border border-[#909090] px-1.5 rounded-md">
                  {visitItem.myReview === true ? (
                    <Link>Î¶¨Î∑∞ ÌôïÏù∏ÌïòÍ∏∞</Link>
                  ) : (
                    <Link>Î¶¨Î∑∞ ÏûëÏÑ±ÌïòÍ∏∞</Link>
                  )}
                </span>
              </div>
              <ul className="flex flex-wrap gap-2.5">
                {visitItem.visitors.map((visitor) => (
                  <li
                    key={visitor.id}
                    className={`relative flex text-sm justify-between items-center bg-[#F8F8F8] flex-[1_1_calc(50%-5px)] p-3 rounded-lg`}
                  >
                    <div className="w-full flex flex-col gap-1">
                      <div className="flex gap-0.5">
                        <p className="whitespace-nowrap">
                          {visitor.nickname}
                        </p>
                        <div className="flex flex-1 flex-shrink-0 items-center">
                          <div>{viewMedal(visitor.matchingCount)}</div>
                          {benOrBlock(visitor)}
                        </div>
                      </div>
                      <div className="text-left text-[#555555]">
                        {visitor.description}
                      </div>
                    </div>
                    <div>
                      <p
                        className="font-bold tracking-[-0.15rem] [writing-mode:vertical-rl] cursor-pointer"
                        onClick={() => popOver(visitor.id)}
                      >
                        ¬∑¬∑¬∑
                      </p>
                      {activePopOver === visitor.id && (
                        <div
                          ref={popOverRef} // ‚úÖ popOverRef ÏÑ§Ï†ï
                          className="absolute flex flex-col gap-1 z-50 top-10 right-1 bg-white p-2 border border-gray-300 rounded-lg"
                        >
                          {visitor.block === false ? (
                            <button
                              onClick={() => toggleModal("block", visitor.id)}
                              className="py-1 px-2 rounded-lg hover:bg-gray-200"
                            >
                              Ï∞®Îã®ÌïòÍ∏∞
                            </button>
                          ) : (
                            <button
                              onClick={() => toggleModal("unBlock", visitor.id)}
                              className="py-1 px-2 rounded-lg hover:bg-gray-200"
                            >
                              Ï∞®Îã®Ìï¥Ï†ú
                            </button>
                          )}
                          {visitor.report === false ? (
                            <button
                              onClick={() => toggleModal("report", visitor.id)}
                              className="py-1 px-2 rounded-lg hover:bg-gray-200"
                            >
                              Ïã†Í≥†ÌïòÍ∏∞
                            </button>
                          ) : (
                            <button
                              onClick={() => toggleModal("unReport", visitor.id)}
                              className="py-1 px-2 rounded-lg hover:bg-gray-200"
                            >
                              Ïã†Í≥†Ìï¥Ï†ú
                            </button>
                          )}
                          <div
                            className="absolute -top-1.5 right-3 rotate-45  w-2.5 h-2.5 bg-white border-l border-t border-gray-300">
                          </div>
                        </div>
                      )}
                    </div>
                  </li>
                ))}
              </ul>
            </li>
          ))
        ) : (
          /* Î∞©Î¨∏Ìïú ÏãùÎãπÏù¥ ÏóÜÏùÑ Îïå Î≥¥Ïùº ÌôîÎ©¥ */
          <div className="text-2xl text-gray-500">Î∞©Î¨∏Ìïú ÏãùÎãπÏù¥ ÏóÜÏäµÎãàÎã§.</div>
        )}
      </ul>

      {/* Î™®Îã¨Ïù¥ Ïó¥Î†§ ÏûàÏùÑ ÎïåÎßå ÌëúÏãú */}
      {/* {isModalOpen && (
        <TwoBtnModal type={modalType} userId={userId} onClose={closeModal} />
      )} */}

      {/* ÏïÑÎûòÎ∂ÄÎ∂Ñ Ïª¥Ìè¨ÎÑåÌä∏Ìôî ÌïÑÏöî */}
      {isModalOpen && (
        <div className="flex fixed top-0 left-0 justify-center items-center bg-black/40 z-50 w-full h-full">
          {!showOneBtnModal ? (
            <div className="w-80 p-10 bg-white rounded-lg drop-shadow-lg">
              <div>Ï†ïÎßê{modalType}ÌïòÏãúÍ≤†ÏäµÎãàÍπå?</div>
              <div className="flex closeModal(true)-8 justify-center">
                <button onClick={closeModal}>ÏïÑÎãàÏöî</button>
                <button onClick={() => changeState(modalType, userId)}>
                  Ïòà
                </button>
              </div>
            </div>
          ) : (
            <div className="w-80 p-10 bg-white rounded-lg drop-shadow-lg">
              <div>ÏÇ¨Ïö©ÏûêÎ•º{modalType}ÌñàÏäµÎãàÎã§.</div>
              <div className="flex gap-8 justify-center">
                <button onClick={closeModal}>ÌôïÏù∏</button>
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
